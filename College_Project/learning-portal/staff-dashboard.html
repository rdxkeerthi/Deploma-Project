<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - Learning Portal</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/components.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand" style="display: flex; align-items: center; gap: 0.5rem;">
                <svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                    style="fill: url(#brandGradient);">
                    <defs>
                        <linearGradient id="brandGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path
                        d="M12 3L1 9L5 11.18V17.18L12 21L19 17.18V11.18L21 10.09V17H23V9L12 3ZM18.82 9L12 12.72L5.18 9L12 5.28L18.82 9ZM17 15.99L12 18.72L7 15.99V12.27L12 15L17 12.27V15.99Z" />
                </svg>
                <span>Learning Portal</span>
            </div>
            <div class="navbar-menu">
                <span id="userName" style="color: var(--text-secondary);"></span>
                <button class="theme-toggle" onclick="UI.toggleTheme()" title="Toggle Theme">
                    <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                        class="theme-icon">
                        <path
                            d="M12 3V4M12 20V21M4 12H3M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5M17.6859 17.69L18.5 18.5M21 12H20M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            fill="none" />
                    </svg>
                </button>
                <button class="btn btn-secondary" onclick="Auth.logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container" style="padding-top: 3rem;">
        <!-- Stats Cards -->
        <div class="grid grid-3 mb-4">
            <div class="stat-card">
                <div class="stat-value" id="totalCourses">0</div>
                <div class="stat-label">Total Courses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEnrollments">0</div>
                <div class="stat-label">Total Enrollments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>

        <!-- Course Management -->
        <div class="glass-card">
            <div class="flex-between mb-3">
                <h2>Course Management</h2>
                <button class="btn btn-primary" onclick="showAddCourseModal()">+ Add Course</button>
            </div>

            <!-- Search -->
            <div class="form-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Search courses...">
            </div>

            <!-- Courses Table -->
            <div class="table-container mt-3">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Course Title</th>
                            <th>Instructor</th>
                            <th>Duration</th>
                            <th>Enrolled</th>
                            <th>Completed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="coursesTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Student Enrollments Section -->
        <div class="glass-card" style="margin-top: 2rem;">
            <div class="flex-between mb-3">
                <h2>üìä Student Enrollments</h2>
            </div>
            <div id="enrollmentsList">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Certificates Issued Section -->
        <div class="glass-card" style="margin-top: 2rem;">
            <div class="flex-between mb-3">
                <h2>üèÜ Certificates Issued</h2>
            </div>
            <div id="certificatesList">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/courses.js"></script>
    <script src="js/enrollments.js"></script>
    <script>
        // Require staff authentication
        Auth.requireAuth('staff');

        const session = Auth.getSession();
        document.getElementById('userName').textContent = session.name;

        // Load stats
        function loadStats() {
            const courses = Courses.getAll();
            const enrollments = Storage.get(Storage.KEYS.ENROLLMENTS, []);
            const completed = enrollments.filter(e => e.completed).length;

            document.getElementById('totalCourses').textContent = courses.length;
            document.getElementById('totalEnrollments').textContent = enrollments.length;
            document.getElementById('completionRate').textContent =
                enrollments.length > 0 ? Math.round((completed / enrollments.length) * 100) + '%' : '0%';
        }

        // Load courses table
        function loadCourses(searchQuery = '') {
            const courses = searchQuery ? Courses.search(searchQuery) : Courses.getAll();
            const tbody = document.getElementById('coursesTableBody');

            if (courses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No courses found</td></tr>';
                return;
            }

            tbody.innerHTML = courses.map(course => {
                const stats = Courses.getStats(course.id);
                return `
                    <tr>
                        <td><strong>${course.title}</strong></td>
                        <td>${course.instructor}</td>
                        <td>${course.duration}</td>
                        <td><span class="badge badge-info">${stats.totalEnrolled}</span></td>
                        <td><span class="badge badge-success">${stats.completed}</span></td>
                        <td>
                            <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="editCourse('${course.id}')">Edit</button>
                            <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="deleteCourse('${course.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            loadCourses(e.target.value);
        });

        // Add course modal
        function showAddCourseModal() {
            UI.showModal('Add New Course', `
                <form id="addCourseForm">
                    <div class="form-group">
                        <label class="form-label">Course Title</label>
                        <input type="text" id="courseTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Instructor</label>
                        <input type="text" id="courseInstructor" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <input type="text" id="courseDuration" class="form-control" placeholder="e.g., 8 weeks" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="courseDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lessons</label>
                        <div id="lessonsList"></div>
                        <button type="button" class="btn btn-outline" onclick="addLessonField()" style="width: 100%; margin-top: 0.5rem;">+ Add Lesson</button>
                    </div>
                </form>
            `, [
                { text: 'Cancel', class: 'btn-secondary', onClick: () => UI.closeModal() },
                { text: 'Add Course', class: 'btn-primary', onClick: handleAddCourse }
            ]);

            // Add first lesson field
            addLessonField();
        }

        let lessonCounter = 0;
        function addLessonField() {
            lessonCounter++;
            const lessonsList = document.getElementById('lessonsList');
            const lessonDiv = document.createElement('div');
            lessonDiv.className = 'lesson-field';
            lessonDiv.style.cssText = 'background: var(--bg-tertiary); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;';
            lessonDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <strong>Lesson ${lessonCounter}</strong>
                    <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.remove()" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Remove</button>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label" style="font-size: 0.85rem;">Lesson Title</label>
                    <input type="text" class="form-control lesson-title" placeholder="e.g., Introduction to HTML" required>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label" style="font-size: 0.85rem;">Duration</label>
                    <input type="text" class="form-control lesson-duration" placeholder="e.g., 30 min" required>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label" style="font-size: 0.85rem;">Video URL (YouTube/Vimeo embed link)</label>
                    <input type="url" class="form-control lesson-video" placeholder="https://www.youtube.com/embed/...">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">Document URL (Optional)</label>
                    <input type="url" class="form-control lesson-document" placeholder="https://example.com/document.pdf">
                </div>
            `;
            lessonsList.appendChild(lessonDiv);
        }

        function handleAddCourse() {
            const title = document.getElementById('courseTitle').value;
            const instructor = document.getElementById('courseInstructor').value;
            const duration = document.getElementById('courseDuration').value;
            const description = document.getElementById('courseDescription').value;

            // Collect lessons from dynamic fields
            const lessonFields = document.querySelectorAll('.lesson-field');
            const lessons = Array.from(lessonFields).map((field, idx) => ({
                id: `lesson_${Date.now()}_${idx}`,
                title: field.querySelector('.lesson-title').value,
                duration: field.querySelector('.lesson-duration').value,
                videoUrl: field.querySelector('.lesson-video').value || '',
                documentUrl: field.querySelector('.lesson-document').value || ''
            }));

            if (lessons.length === 0) {
                UI.showToast('Please add at least one lesson', 'error');
                return;
            }

            Courses.create({ title, instructor, duration, description, lessons });
            UI.closeModal();
            UI.showToast('Course added successfully!', 'success');
            loadCourses();
            loadStats();
            lessonCounter = 0; // Reset counter
        }

        function editCourse(courseId) {
            const course = Courses.getById(courseId);
            if (!course) return;

            UI.showModal('Edit Course', `
                <form id="editCourseForm">
                    <div class="form-group">
                        <label class="form-label">Course Title</label>
                        <input type="text" id="editTitle" class="form-control" value="${course.title}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Instructor</label>
                        <input type="text" id="editInstructor" class="form-control" value="${course.instructor}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <input type="text" id="editDuration" class="form-control" value="${course.duration}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="editDescription" class="form-control" rows="3" required>${course.description}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lessons</label>
                        <div id="editLessonsList"></div>
                        <button type="button" class="btn btn-outline" onclick="addEditLessonField()" style="width: 100%; margin-top: 0.5rem;">+ Add Lesson</button>
                    </div>
                </form>
            `, [
                { text: 'Cancel', class: 'btn-secondary', onClick: () => UI.closeModal() },
                { text: 'Save Changes', class: 'btn-primary', onClick: () => handleEditCourse(courseId) }
            ]);

            // Populate existing lessons
            lessonCounter = 0;
            course.lessons.forEach(lesson => {
                addEditLessonField(lesson);
            });
        }

        function addEditLessonField(lessonData = null) {
            lessonCounter++;
            const lessonsList = document.getElementById('editLessonsList');
            const lessonDiv = document.createElement('div');
            lessonDiv.className = 'lesson-field';
            lessonDiv.style.cssText = 'background: var(--bg-tertiary); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;';
            lessonDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <strong>Lesson ${lessonCounter}</strong>
                    <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.remove()" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Remove</button>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label" style="font-size: 0.85rem;">Lesson Title</label>
                    <input type="text" class="form-control lesson-title" placeholder="e.g., Introduction to HTML" value="${lessonData ? lessonData.title : ''}" required>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label" style="font-size: 0.85rem;">Duration</label>
                    <input type="text" class="form-control lesson-duration" placeholder="e.g., 30 min" value="${lessonData ? lessonData.duration : ''}" required>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label" style="font-size: 0.85rem;">Video URL (YouTube/Vimeo embed link)</label>
                    <input type="url" class="form-control lesson-video" placeholder="https://www.youtube.com/embed/..." value="${lessonData ? (lessonData.videoUrl || '') : ''}">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">Document URL (Optional)</label>
                    <input type="url" class="form-control lesson-document" placeholder="https://example.com/document.pdf" value="${lessonData ? (lessonData.documentUrl || '') : ''}">
                </div>
            `;
            lessonsList.appendChild(lessonDiv);
        }

        function handleEditCourse(courseId) {
            const title = document.getElementById('editTitle').value;
            const instructor = document.getElementById('editInstructor').value;
            const duration = document.getElementById('editDuration').value;
            const description = document.getElementById('editDescription').value;

            // Collect lessons from dynamic fields
            const lessonFields = document.querySelectorAll('.lesson-field');
            const lessons = Array.from(lessonFields).map((field, idx) => ({
                id: `lesson_${Date.now()}_${idx}`,
                title: field.querySelector('.lesson-title').value,
                duration: field.querySelector('.lesson-duration').value,
                videoUrl: field.querySelector('.lesson-video').value || '',
                documentUrl: field.querySelector('.lesson-document').value || ''
            }));

            if (lessons.length === 0) {
                UI.showToast('Please add at least one lesson', 'error');
                return;
            }

            Courses.update(courseId, { title, instructor, duration, description, lessons });
            UI.closeModal();
            UI.showToast('Course updated successfully!', 'success');
            loadCourses();
            lessonCounter = 0; // Reset counter
        }

        async function deleteCourse(courseId) {
            const confirmed = await UI.confirm('Are you sure you want to delete this course? This will also remove all student enrollments.');
            if (confirmed) {
                Courses.delete(courseId);
                UI.showToast('Course deleted successfully!', 'success');
                loadCourses();
                loadStats();
            }
        }

        function renderEnrollments() {
            const allEnrollments = Storage.get(Storage.KEYS.ENROLLMENTS, []);
            const allUsers = Storage.get(Storage.KEYS.USERS, []);
            const container = document.getElementById('enrollmentsList');

            if (allEnrollments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üìö</div>
                        <p>No student enrollments yet.</p>
                    </div>
                `;
                return;
            }

            // Group by course
            const enrollmentsByCourse = {};
            allEnrollments.forEach(enrollment => {
                if (!enrollmentsByCourse[enrollment.courseId]) {
                    enrollmentsByCourse[enrollment.courseId] = [];
                }
                enrollmentsByCourse[enrollment.courseId].push(enrollment);
            });

            container.innerHTML = Object.entries(enrollmentsByCourse).map(([courseId, enrollments]) => {
                const course = Courses.getById(courseId);
                if (!course) return '';

                const totalEnrolled = enrollments.length;
                const completed = enrollments.filter(e => e.completed).length;
                const inProgress = totalEnrolled - completed;

                return `
                    <div class="glass-card" style="padding: 1.5rem; margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem;">${course.title}</h3>
                        <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                            <div>
                                <p style="font-size: 0.8rem; color: var(--text-tertiary); text-transform: uppercase; margin: 0;">Total Enrolled</p>
                                <p style="font-size: 1.5rem; font-weight: 700; margin: 0.25rem 0 0 0;">${totalEnrolled}</p>
                            </div>
                            <div>
                                <p style="font-size: 0.8rem; color: var(--text-tertiary); text-transform: uppercase; margin: 0;">Completed</p>
                                <p style="font-size: 1.5rem; font-weight: 700; margin: 0.25rem 0 0 0; color: var(--success);">${completed}</p>
                            </div>
                            <div>
                                <p style="font-size: 0.8rem; color: var(--text-tertiary); text-transform: uppercase; margin: 0;">In Progress</p>
                                <p style="font-size: 1.5rem; font-weight: 700; margin: 0.25rem 0 0 0; color: var(--accent-primary);">${inProgress}</p>
                            </div>
                        </div>
                        <details style="margin-top: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 8px;">View Student Details</summary>
                            <div style="margin-top: 1rem;">
                                ${enrollments.map(enrollment => {
                    const enrolledDate = new Date(enrollment.enrolledAt).toLocaleDateString();
                    const student = allUsers.find(u => u.id === enrollment.studentId);
                    const studentName = student ? student.name : 'Unknown Student';
                    const studentEmail = student ? student.email : '';

                    return `
                                        <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <p style="font-weight: 600; margin: 0; font-size: 1rem;">${studentName}</p>
                                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">${studentEmail}</p>
                                                    <p style="font-size: 0.8rem; color: var(--text-tertiary); margin: 0.25rem 0 0 0;">Enrolled: ${enrolledDate}</p>
                                                </div>
                                                <div style="text-align: right;">
                                                    <p style="font-weight: 600; margin: 0;">${enrollment.progress}%</p>
                                                    <span class="badge" style="background: ${enrollment.completed ? 'var(--success)' : 'var(--accent-primary)'}; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.8rem;">
                                                        ${enrollment.completed ? '‚úì Completed' : 'In Progress'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                }).join('')}
                            </div>
                        </details>
                    </div>
                `;
            }).join('');
        }

        function renderCertificates() {
            const allEnrollments = Storage.get(Storage.KEYS.ENROLLMENTS, []);
            const allUsers = Storage.get(Storage.KEYS.USERS, []);
            const completedEnrollments = allEnrollments.filter(e => e.completed);
            const container = document.getElementById('certificatesList');

            if (completedEnrollments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üéì</div>
                        <p>No certificates issued yet.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <p style="font-size: 1.2rem; font-weight: 600;">Total Certificates Issued: <span style="color: var(--accent-primary);">${completedEnrollments.length}</span></p>
                </div>
                ${completedEnrollments.map(enrollment => {
                const course = Courses.getById(enrollment.courseId);
                const student = allUsers.find(u => u.id === enrollment.studentId);
                const studentName = student ? student.name : 'Unknown Student';
                const studentEmail = student ? student.email : '';
                const completedDate = enrollment.completedAt
                    ? new Date(enrollment.completedAt).toLocaleDateString(undefined, { dateStyle: 'long' })
                    : 'Unknown';
                const certId = enrollment.id.replace('enroll_', 'CERT-').toUpperCase();

                return `
                        <div class="glass-card" style="padding: 1.5rem; margin-bottom: 1rem; border-left: 4px solid var(--accent-primary);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                        <span style="font-size: 2rem;">üèÜ</span>
                                        <div>
                                            <h4 style="margin: 0;">${course ? course.title : 'Unknown Course'}</h4>
                                            <p style="color: var(--text-primary); margin: 0.25rem 0 0 0; font-size: 1rem; font-weight: 600;">Awarded to: ${studentName}</p>
                                            <p style="color: var(--text-secondary); margin: 0.25rem 0 0 0; font-size: 0.85rem;">${studentEmail}</p>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 2rem; margin-top: 1rem;">
                                        <div>
                                            <p style="font-size: 0.8rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin: 0;">Completed</p>
                                            <p style="font-weight: 600; margin: 0.25rem 0 0 0;">${completedDate}</p>
                                        </div>
                                        <div>
                                            <p style="font-size: 0.8rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin: 0;">Certificate ID</p>
                                            <p style="font-weight: 600; font-family: monospace; margin: 0.25rem 0 0 0;">${certId}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            }).join('')}
            `;
        }

        // Initial load
        loadStats();
        loadCourses();
        renderEnrollments();
        renderCertificates();
    </script>
</body>

</html>